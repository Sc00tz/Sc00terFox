name: Build Firefox Desktop

on:
  workflow_dispatch:
    inputs:
      firefox_version:
        description: 'Firefox version (e.g., 132.0 or latest)'
        required: false
        default: 'latest'
  schedule:
    - cron: '0 2 * * 0'

permissions:
  contents: write

jobs:
  determine-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      should_build: ${{ steps.check-existing.outputs.should_build }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Get Firefox version
        id: get-version
        run: |
          if [ "${{ inputs.firefox_version || 'latest' }}" = "latest" ]; then
            VERSION=$(curl -s 'https://product-details.mozilla.org/1.0/firefox_versions.json' | jq -r '.LATEST_FIREFOX_VERSION')
          else
            VERSION="${{ inputs.firefox_version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building Firefox $VERSION"
      
      - name: Check if version already built
        id: check-existing
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if gh release view "v$VERSION" >/dev/null 2>&1; then
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  # Linux build disabled - not currently needed
  # build-linux:
  #   needs: determine-version
  #   if: needs.determine-version.outputs.should_build == 'true'
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 360
  #
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Free up disk space
  #       run: |
  #         df -h
  #         sudo rm -rf /usr/share/dotnet
  #         sudo rm -rf /usr/local/lib/android
  #         sudo rm -rf /opt/ghc
  #         sudo rm -rf /opt/hostedtoolcache/CodeQL
  #         sudo docker image prune --all --force
  #         df -h
  #
  #     - name: Install build dependencies
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y mercurial build-essential libgtk-3-dev libdbus-glib-1-dev libpulse-dev libxt-dev autoconf2.13 yasm nasm libx11-xcb-dev nodejs clang llvm rustc cargo cbindgen
  #
  #     - name: Setup Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'
  #
  #     - name: Cache mozbuild
  #       uses: actions/cache@v4
  #       with:
  #         path: |
  #           ~/.mozbuild
  #           ~/.cargo
  #         key: mozbuild-linux-${{ needs.determine-version.outputs.version }}
  #         restore-keys: |
  #           mozbuild-linux-
  #
  #     - name: Download Firefox source
  #       run: |
  #         VERSION="${{ needs.determine-version.outputs.version }}"
  #         curl -L -o firefox-${VERSION}.source.tar.xz "https://archive.mozilla.org/pub/firefox/releases/${VERSION}/source/firefox-${VERSION}.source.tar.xz"
  #         tar -xf firefox-${VERSION}.source.tar.xz
  #         rm firefox-${VERSION}.source.tar.xz
  #
  #     - name: Apply patches
  #       run: |
  #         VERSION="${{ needs.determine-version.outputs.version }}"
  #         cd firefox-${VERSION}
  #         if [ -d "../patches/desktop" ] && [ "$(ls -A ../patches/desktop/*.patch 2>/dev/null)" ]; then
  #           for patch in ../patches/desktop/*.patch; do
  #             echo "Applying $(basename $patch)..."
  #             patch -p1 < "$patch"
  #           done
  #         else
  #           echo "No patches found"
  #         fi
  #
  #     - name: Setup mozconfig
  #       run: |
  #         VERSION="${{ needs.determine-version.outputs.version }}"
  #         if [ -f "configs/mozconfig-linux" ]; then
  #           cp configs/mozconfig-linux firefox-${VERSION}/mozconfig
  #         else
  #           cat > firefox-${VERSION}/mozconfig << 'MOZCONFIG_END'
  #         ac_add_options --enable-application=browser
  #         ac_add_options --enable-optimize
  #         ac_add_options --disable-debug
  #         ac_add_options --disable-tests
  #         ac_add_options --enable-release
  #         ac_add_options --with-branding=browser/branding/unofficial
  #         ac_add_options --disable-crashreporter
  #         ac_add_options --disable-updater
  #         mk_add_options MOZ_MAKE_FLAGS="-j$(nproc)"
  #         MOZCONFIG_END
  #         fi
  #         cat firefox-${VERSION}/mozconfig
  #
  #     - name: Bootstrap build environment
  #       run: |
  #         VERSION="${{ needs.determine-version.outputs.version }}"
  #         cd firefox-${VERSION}
  #         export MOZBUILD_STATE_PATH=$HOME/.mozbuild
  #         ./mach --no-interactive bootstrap --application-choice=browser
  #
  #     - name: Build Firefox
  #       run: |
  #         VERSION="${{ needs.determine-version.outputs.version }}"
  #         cd firefox-${VERSION}
  #         export MOZBUILD_STATE_PATH=$HOME/.mozbuild
  #         ./mach build
  #
  #     - name: Package Firefox
  #       run: |
  #         VERSION="${{ needs.determine-version.outputs.version }}"
  #         cd firefox-${VERSION}
  #         ./mach package
  #
  #         # Debug: show what files were created
  #         echo "Contents of obj-*/dist:"
  #         ls -la obj-*/dist/ || true
  #
  #         # Find the package - try multiple patterns
  #         PACKAGE=$(find obj-*/dist -name "firefox-*.tar.bz2" -o -name "*.tar.bz2" | grep -v "crashreporter" | head -1)
  #
  #         if [ -z "$PACKAGE" ]; then
  #           echo "ERROR: No package file found!"
  #           echo "Searching for any .tar.bz2 files:"
  #           find obj-*/dist -name "*.tar.bz2"
  #           exit 1
  #         fi
  #
  #         echo "Found package: $PACKAGE"
  #         cp "$PACKAGE" ../firefox-custom-${VERSION}-linux-x86_64.tar.bz2
  #         cd ..
  #         sha256sum firefox-custom-${VERSION}-linux-x86_64.tar.bz2 > firefox-custom-${VERSION}-linux-x86_64.tar.bz2.sha256
  #
  #     - name: Upload artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: firefox-linux-${{ needs.determine-version.outputs.version }}
  #         path: |
  #           firefox-custom-*.tar.bz2
  #           firefox-custom-*.sha256
  #         retention-days: 7

  build-macos:
    needs: determine-version
    if: needs.determine-version.outputs.should_build == 'true'
    runs-on: macos-14
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Free up disk space
        run: |
          df -h
          sudo rm -rf /Users/runner/Library/Android
          sudo rm -rf /usr/local/lib/android
          df -h
      
      - name: Install build dependencies
        run: |
          brew install mercurial python@3.11 rust nasm yasm node cbindgen
      
      - name: Cache mozbuild
        uses: actions/cache@v4
        with:
          path: |
            ~/.mozbuild
            ~/.cargo
          key: mozbuild-macos-arm64-${{ needs.determine-version.outputs.version }}
          restore-keys: |
            mozbuild-macos-arm64-
      
      - name: Download Firefox source
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          curl -L -o firefox-${VERSION}.source.tar.xz "https://archive.mozilla.org/pub/firefox/releases/${VERSION}/source/firefox-${VERSION}.source.tar.xz"
          tar -xf firefox-${VERSION}.source.tar.xz
          rm firefox-${VERSION}.source.tar.xz
      
      - name: Apply patches
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          cd firefox-${VERSION}
          if [ -d "../patches/desktop" ] && [ "$(ls -A ../patches/desktop/*.patch 2>/dev/null)" ]; then
            for patch in ../patches/desktop/*.patch; do
              echo "Applying $(basename $patch)..."
              patch -p1 < "$patch"
            done
          else
            echo "No patches found"
          fi
      
      - name: Setup mozconfig
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          if [ -f "configs/mozconfig-macos" ]; then
            cp configs/mozconfig-macos firefox-${VERSION}/mozconfig
            # Update target architecture to ARM64 if needed
            if grep -q "target=x86_64-apple-darwin" firefox-${VERSION}/mozconfig; then
              sed -i '' "s/target=x86_64-apple-darwin/target=aarch64-apple-darwin/" firefox-${VERSION}/mozconfig
            fi
          else
            cat > firefox-${VERSION}/mozconfig << 'MOZCONFIG_END'
          ac_add_options --enable-application=browser
          ac_add_options --enable-optimize
          ac_add_options --disable-debug
          ac_add_options --disable-tests
          ac_add_options --enable-release
          ac_add_options --with-branding=browser/branding/unofficial
          ac_add_options --disable-crashreporter
          ac_add_options --disable-updater
          ac_add_options --target=aarch64-apple-darwin
          mk_add_options MOZ_MAKE_FLAGS="-j$(sysctl -n hw.ncpu)"
          MOZCONFIG_END
          fi
          cat firefox-${VERSION}/mozconfig
      
      - name: Bootstrap build environment
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          cd firefox-${VERSION}
          export MOZBUILD_STATE_PATH=$HOME/.mozbuild
          ./mach --no-interactive bootstrap --application-choice=browser
      
      - name: Build Firefox
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          cd firefox-${VERSION}
          export MOZBUILD_STATE_PATH=$HOME/.mozbuild
          ./mach build
      
      - name: Package Firefox
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          cd firefox-${VERSION}
          ./mach package

          # Debug: show what files were created
          echo "Contents of obj-*/dist:"
          ls -la obj-*/dist/ || true

          # Find the DMG package
          DMG=$(find obj-*/dist -name "*.dmg" | head -1)

          if [ -z "$DMG" ]; then
            echo "ERROR: No DMG file found!"
            echo "Searching for all files in dist:"
            find obj-*/dist -type f
            exit 1
          fi

          echo "Found DMG: $DMG"
          cp "$DMG" ../firefox-custom-${VERSION}-macos-arm64.dmg
          cd ..
          shasum -a 256 firefox-custom-${VERSION}-macos-arm64.dmg > firefox-custom-${VERSION}-macos-arm64.dmg.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: firefox-macos-${{ needs.determine-version.outputs.version }}
          path: |
            firefox-custom-*-macos-*.dmg
            firefox-custom-*-macos-*.dmg.sha256
          retention-days: 7

  create-release:
    needs: [determine-version, build-macos]
    if: needs.determine-version.outputs.should_build == 'true' && needs.build-macos.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release files
        run: |
          mkdir release-files
          find artifacts -type f -exec cp {} release-files/ \;
          ls -lh release-files/
      
      - name: Create build info
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          echo "Firefox Custom Build v${VERSION}" > release-files/BUILD-INFO.txt
          echo "Build Date: $(date -u)" >> release-files/BUILD-INFO.txt
          echo "Repository: ${{ github.repository }}" >> release-files/BUILD-INFO.txt
          echo "Commit: ${{ github.sha }}" >> release-files/BUILD-INFO.txt
          cat release-files/BUILD-INFO.txt
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.determine-version.outputs.version }}
          name: Firefox Custom v${{ needs.determine-version.outputs.version }}
          body_path: release-files/BUILD-INFO.txt
          files: release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}