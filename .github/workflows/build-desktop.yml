name: Build Firefox Desktop

on:
  workflow_dispatch:
    inputs:
      firefox_version:
        description: 'Firefox version (e.g., 132.0 or latest)'
        required: false
        default: 'latest'
      platforms:
        description: 'Platforms to build (comma-separated: linux,macos or all)'
        required: false
        default: 'all'
  schedule:
    # Weekly builds on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

env:
  FIREFOX_VERSION: ${{ github.event.inputs.firefox_version || 'latest' }}
  BUILD_PLATFORMS: ${{ github.event.inputs.platforms || 'all' }}

jobs:
  determine-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      should_build: ${{ steps.check-existing.outputs.should_build }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Get Firefox version
        id: get-version
        run: |
          if [ "${{ env.FIREFOX_VERSION }}" = "latest" ]; then
            VERSION=$(curl -s 'https://product-details.mozilla.org/1.0/firefox_versions.json' | \
              jq -r '.LATEST_FIREFOX_VERSION')
          else
            VERSION="${{ env.FIREFOX_VERSION }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building Firefox $VERSION"
      
      - name: Check if version already built
        id: check-existing
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          
          # Check if release exists
          if gh release view "v$VERSION" >/dev/null 2>&1; then
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "Version $VERSION already built"
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "Version $VERSION needs building"
          fi

  build-linux:
    needs: determine-version
    if: |
      needs.determine-version.outputs.should_build == 'true' &&
      (contains(github.event.inputs.platforms, 'linux') || 
       contains(github.event.inputs.platforms, 'all') ||
       github.event_name == 'schedule')
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h
          
          # Remove unnecessary software
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          
          echo "After cleanup:"
          df -h
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            mercurial \
            python3-pip \
            build-essential \
            libgtk-3-dev \
            libdbus-glib-1-dev \
            libpulse-dev \
            libxt-dev \
            autoconf2.13 \
            yasm \
            nasm \
            libx11-xcb-dev \
            nodejs \
            clang \
            llvm \
            rustc \
            cargo \
            cbindgen
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache mozbuild
        uses: actions/cache@v4
        with:
          path: |
            ~/.mozbuild
            ~/.cargo
          key: mozbuild-linux-${{ needs.determine-version.outputs.version }}
          restore-keys: |
            mozbuild-linux-
      
      - name: Download Firefox source
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          echo "Downloading Firefox $VERSION source..."
          
          wget -q --show-progress \
            "https://archive.mozilla.org/pub/firefox/releases/${VERSION}/source/firefox-${VERSION}.source.tar.xz"
          
          echo "Extracting source..."
          tar -xf firefox-${VERSION}.source.tar.xz
          rm firefox-${VERSION}.source.tar.xz
      
      - name: Apply patches
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          cd firefox-${VERSION}
          
          if [ -d "../patches/desktop" ] && [ "$(ls -A ../patches/desktop/*.patch 2>/dev/null)" ]; then
            echo "Applying desktop patches..."
            for patch in ../patches/desktop/*.patch; do
              echo "Applying $(basename $patch)..."
              patch -p1 < "$patch"
            done
          else
            echo "No patches found, building stock Firefox"
          fi
      
      - name: Setup mozconfig
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          
          if [ -f "configs/mozconfig-linux" ]; then
            cp configs/mozconfig-linux firefox-${VERSION}/mozconfig
          else
            # Create default mozconfig
            cat > firefox-${VERSION}/mozconfig <<'EOF'
# Build Firefox for Linux
ac_add_options --enable-application=browser
ac_add_options --enable-optimize
ac_add_options --disable-debug
ac_add_options --disable-tests
ac_add_options --enable-release

# Branding
ac_add_options --with-branding=browser/branding/unofficial

# Disable unwanted features
ac_add_options --disable-crashreporter
ac_add_options --disable-updater

# Performance
mk_add_options MOZ_MAKE_FLAGS="-j$(nproc)"
EOF
          fi
          
          echo "Using mozconfig:"
          cat firefox-${VERSION}/mozconfig
      
      - name: Bootstrap build environment
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          cd firefox-${VERSION}
          
          export MOZBUILD_STATE_PATH=$HOME/.mozbuild
          ./mach --no-interactive bootstrap --application-choice=browser
      
      - name: Build Firefox
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          cd firefox-${VERSION}
          
          export MOZBUILD_STATE_PATH=$HOME/.mozbuild
          
          echo "Starting build at $(date)"
          ./mach build
          echo "Build completed at $(date)"
      
      - name: Package Firefox
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          cd firefox-${VERSION}
          
          ./mach package
          
          # Find and rename package
          PACKAGE=$(find obj-*/dist -name "firefox-*.tar.bz2" | head -1)
          cp "$PACKAGE" ../firefox-custom-${VERSION}-linux-x86_64.tar.bz2
          
          # Create checksums
          cd ..
          sha256sum firefox-custom-${VERSION}-linux-x86_64.tar.bz2 > \
            firefox-custom-${VERSION}-linux-x86_64.tar.bz2.sha256
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: firefox-linux-${{ needs.determine-version.outputs.version }}
          path: |
            firefox-custom-*.tar.bz2
            firefox-custom-*.sha256
          retention-days: 7

  build-macos:
    needs: determine-version
    if: |
      needs.determine-version.outputs.should_build == 'true' &&
      (contains(github.event.inputs.platforms, 'macos') || 
       contains(github.event.inputs.platforms, 'all') ||
       github.event_name == 'schedule')
    runs-on: macos-13
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h
          
          # Clean up
          sudo rm -rf /Users/runner/Library/Android
          sudo rm -rf /usr/local/lib/android
          
          echo "After cleanup:"
          df -h
      
      - name: Install build dependencies
        run: |
          brew install mercurial python@3.11 rust nasm yasm node cbindgen
      
      - name: Cache mozbuild
        uses: actions/cache@v4
        with:
          path: |
            ~/.mozbuild
            ~/.cargo
          key: mozbuild-macos-${{ needs.determine-version.outputs.version }}
          restore-keys: |
            mozbuild-macos-
      
      - name: Download Firefox source
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          echo "Downloading Firefox $VERSION source..."
          
          wget -q --show-progress \
            "https://archive.mozilla.org/pub/firefox/releases/${VERSION}/source/firefox-${VERSION}.source.tar.xz"
          
          echo "Extracting source..."
          tar -xf firefox-${VERSION}.source.tar.xz
          rm firefox-${VERSION}.source.tar.xz
      
      - name: Apply patches
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          cd firefox-${VERSION}
          
          if [ -d "../patches/desktop" ] && [ "$(ls -A ../patches/desktop/*.patch 2>/dev/null)" ]; then
            echo "Applying desktop patches..."
            for patch in ../patches/desktop/*.patch; do
              echo "Applying $(basename $patch)..."
              patch -p1 < "$patch"
            done
          else
            echo "No patches found, building stock Firefox"
          fi
      
      - name: Setup mozconfig
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          
          if [ -f "configs/mozconfig-macos" ]; then
            cp configs/mozconfig-macos firefox-${VERSION}/mozconfig
          else
            # Create default mozconfig for macOS
            cat > firefox-${VERSION}/mozconfig <<'EOF'
# Build Firefox for macOS
ac_add_options --enable-application=browser
ac_add_options --enable-optimize
ac_add_options --disable-debug
ac_add_options --disable-tests
ac_add_options --enable-release

# Branding
ac_add_options --with-branding=browser/branding/unofficial

# Disable unwanted
ac_add_options --disable-crashreporter
ac_add_options --disable-updater

# macOS specific
ac_add_options --target=x86_64-apple-darwin

# Performance
mk_add_options MOZ_MAKE_FLAGS="-j$(sysctl -n hw.ncpu)"
EOF
          fi
          
          cat firefox-${VERSION}/mozconfig
      
      - name: Bootstrap build environment
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          cd firefox-${VERSION}
          
          export MOZBUILD_STATE_PATH=$HOME/.mozbuild
          ./mach --no-interactive bootstrap --application-choice=browser
      
      - name: Build Firefox
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          cd firefox-${VERSION}
          
          export MOZBUILD_STATE_PATH=$HOME/.mozbuild
          
          echo "Starting macOS build at $(date)"
          ./mach build
          echo "Build completed at $(date)"
      
      - name: Package Firefox
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          cd firefox-${VERSION}
          
          ./mach package
          
          # Find and rename DMG
          DMG=$(find obj-*/dist -name "*.dmg" | head -1)
          cp "$DMG" ../firefox-custom-${VERSION}-macos.dmg
          
          # Create checksums
          cd ..
          shasum -a 256 firefox-custom-${VERSION}-macos.dmg > \
            firefox-custom-${VERSION}-macos.dmg.sha256
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: firefox-macos-${{ needs.determine-version.outputs.version }}
          path: |
            firefox-custom-*.dmg
            firefox-custom-*.sha256
          retention-days: 7

  create-release:
    needs: [determine-version, build-linux, build-macos]
    if: always() && needs.determine-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release files
        run: |
          mkdir release-files
          find artifacts -type f -exec cp {} release-files/ \;
          ls -lh release-files/
      
      - name: Create build info
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          
          cat > release-files/BUILD-INFO.txt <<EOF
Firefox Custom Build v${VERSION}
================================

Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
Firefox Base Version: ${VERSION}
Built via: GitHub Actions
Repository: ${{ github.repository }}
Commit: ${{ github.sha }}

Platforms:
----------
EOF
          
          if [ -f "release-files/firefox-custom-${VERSION}-linux-x86_64.tar.bz2" ]; then
            echo "✓ Linux x86_64" >> release-files/BUILD-INFO.txt
          fi
          
          if [ -f "release-files/firefox-custom-${VERSION}-macos.dmg" ]; then
            echo "✓ macOS" >> release-files/BUILD-INFO.txt
          fi
          
          cat >> release-files/BUILD-INFO.txt <<EOF

Installation:
-------------
Linux:
  tar -xf firefox-custom-${VERSION}-linux-x86_64.tar.bz2
  ./firefox/firefox

macOS:
  Open firefox-custom-${VERSION}-macos.dmg
  Drag to Applications
  Right-click > Open (first time only)

Custom Features:
----------------
- Self-hosted Firefox Accounts (if patches applied)
- Privacy-enhanced defaults
- Telemetry disabled

Verify Downloads:
-----------------
Check SHA256 checksums against provided .sha256 files

Report Issues:
--------------
${{ github.server_url }}/${{ github.repository }}/issues
EOF
          
          cat release-files/BUILD-INFO.txt
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.determine-version.outputs.version }}
          name: Firefox Custom v${{ needs.determine-version.outputs.version }}
          body_path: release-files/BUILD-INFO.txt
          files: release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}