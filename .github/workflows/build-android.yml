name: Build Firefox Android

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        type: choice
        options:
          - debug
          - release
        default: 'debug'
  schedule:
    # Weekly on Sunday at 4 AM UTC (offset from desktop)
    - cron: '0 4 * * 0'

permissions:
  contents: write

env:
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'debug' }}

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 420
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: |
            ~/.android/sdk
          key: android-sdk-${{ runner.os }}
          restore-keys: |
            android-sdk-

      - name: Install Android SDK components
        run: |
          # Install specific NDK version r28b as required by Firefox
          # Version 28.1.13356709 is NDK r28b
          sdkmanager --install "platform-tools" \
                               "platforms;android-34" \
                               "build-tools;34.0.0" \
                               "ndk;28.1.13356709"

          # Verify NDK r28b is installed
          echo "Installed NDK versions:"
          ls -la $ANDROID_HOME/ndk/ || true

          # Set ANDROID_NDK_HOME to the specific r28b version
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/28.1.13356709" >> $GITHUB_ENV

      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h

          # Remove large packages (but keep Java and Python in hostedtoolcache)
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /opt/hostedtoolcache/go
          sudo rm -rf /opt/hostedtoolcache/PyPy
          sudo rm -rf /opt/hostedtoolcache/node
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/graalvm
          sudo rm -rf /usr/local/.ghcup

          # Remove Android components we don't need
          sudo rm -rf /usr/local/lib/android/sdk/ndk-bundle || true
          sudo rm -rf /usr/local/lib/android/sdk/emulator || true
          sudo rm -rf /usr/local/lib/android/sdk/system-images || true

          # Remove large documentation and sample files
          sudo rm -rf /usr/share/doc
          sudo rm -rf /usr/share/man
          sudo rm -rf /usr/share/locale

          # Remove other toolchains
          sudo rm -rf /opt/az
          sudo rm -rf /opt/microsoft

          # Clean apt cache
          sudo apt-get clean
          sudo apt-get autoremove -y

          # Remove large docker images
          sudo docker image prune --all --force
          sudo docker system prune -a --volumes --force

          echo "After cleanup:"
          df -h
      
      # Gradle cache removed to save disk space - Android builds are large

      - name: Cache mozbuild
        uses: actions/cache@v4
        with:
          path: |
            ~/.mozbuild
            ~/.cargo
          key: mozbuild-android-${{ runner.os }}
          restore-keys: |
            mozbuild-android-
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            mercurial \
            curl \
            wget \
            unzip \
            rustc \
            cargo \
            nodejs
      
      - name: Clone mozilla-central
        id: clone
        run: |
          echo "Cloning mozilla-central..."
          git clone --depth 1 --single-branch --branch master \
            https://github.com/mozilla/gecko-dev.git mozilla-central

          cd mozilla-central
          git log -1 --oneline

          # Extract Firefox version from browser/config/version.txt
          if [ -f "browser/config/version.txt" ]; then
            VERSION=$(cat browser/config/version.txt)
            echo "firefox_version=$VERSION" >> $GITHUB_OUTPUT
            echo "Firefox version: $VERSION"
          else
            echo "firefox_version=unknown" >> $GITHUB_OUTPUT
          fi
      
      - name: Apply patches
        run: |
          cd mozilla-central

          if [ -d "../patches/android" ] && [ "$(ls -A ../patches/android/*.patch 2>/dev/null)" ]; then
            echo "Applying Android patches..."
            for patch in ../patches/android/*.patch; do
              echo "Applying $(basename $patch)..."
              git apply "$patch" || patch -p1 < "$patch"
            done
          else
            echo "No Android patches found"
          fi

      - name: Copy custom preferences
        run: |
          cd mozilla-central

          # Copy custom prefs to GeckoView defaults
          if [ -f "../configs/android-prefs.js" ]; then
            echo "Copying custom Android preferences..."
            mkdir -p mobile/android/app/src/main/assets
            cp ../configs/android-prefs.js mobile/android/app/src/main/assets/geckoview-prefs.js
            echo "Custom preferences installed"
          else
            echo "No custom preferences file found"
          fi

      - name: Setup fake emulator to bypass check
        run: |
          # Create a fake emulator binary to satisfy the configure check
          sudo mkdir -p /usr/local/lib/android/sdk/emulator
          echo '#!/bin/bash' | sudo tee /usr/local/lib/android/sdk/emulator/emulator
          echo 'exit 0' | sudo tee -a /usr/local/lib/android/sdk/emulator/emulator
          sudo chmod +x /usr/local/lib/android/sdk/emulator/emulator

          # Add to PATH so configure can find it
          echo "/usr/local/lib/android/sdk/emulator" >> $GITHUB_PATH

      - name: Setup mozconfig
        run: |
          echo "Using NDK: $ANDROID_NDK_HOME"
          echo "Using SDK: $ANDROID_HOME"

          if [ -f "configs/mozconfig-android" ]; then
            cp configs/mozconfig-android mozilla-central/mozconfig
          else
            cat > mozilla-central/mozconfig <<EOF
          # Build Firefox for Android
          ac_add_options --enable-application=mobile/android
          ac_add_options --target=aarch64-linux-android

          # Optimization
          ac_add_options --enable-optimize
          ac_add_options --disable-debug
          ac_add_options --disable-tests

          # Android SDK/NDK - using r28b
          ac_add_options --with-android-ndk="$ANDROID_NDK_HOME"
          ac_add_options --with-android-sdk="$ANDROID_HOME"

          # Branding
          ac_add_options --with-branding=mobile/android/branding/unofficial

          # Disable unwanted
          ac_add_options --disable-crashreporter
          ac_add_options --disable-updater

          # Disable debug symbols to save massive amounts of disk space
          ac_add_options --disable-debug-symbols

          # Use fewer parallel jobs to reduce disk usage (default is 4 cores on GitHub Actions)
          mk_add_options MOZ_MAKE_FLAGS="-j2"
          EOF
          fi

          echo "Generated mozconfig:"
          cat mozilla-central/mozconfig
      
      - name: Bootstrap build
        run: |
          cd mozilla-central
          export MOZBUILD_STATE_PATH=$HOME/.mozbuild
          ./mach --no-interactive bootstrap --application-choice=mobile_android

      - name: Pre-build disk cleanup
        run: |
          echo "Disk space before pre-build cleanup:"
          df -h

          # Remove Rust documentation and examples to save space
          rm -rf ~/.rustup/toolchains/*/share/doc || true
          rm -rf ~/.cargo/registry/cache || true

          # Clean any temporary files
          sudo rm -rf /tmp/*
          sudo rm -rf /var/tmp/*

          echo "Disk space after pre-build cleanup:"
          df -h

      - name: Configure Cargo for CI
        run: |
          # Disable incremental compilation (adds 20-30% disk overhead in CI)
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml <<'EOF'
          [build]
          incremental = false
          EOF

      - name: Build GeckoView
        run: |
          cd mozilla-central
          export MOZBUILD_STATE_PATH=$HOME/.mozbuild

          # Critical Rust optimizations for disk space
          export CARGO_INCREMENTAL=false
          export RUSTFLAGS="-C debuginfo=0"

          echo "Starting disk space:"
          df -h

          echo "Building GeckoView at $(date)"
          ./mach build

          echo "GeckoView build complete at $(date)"
          echo "Final disk space:"
          df -h

      - name: Clean up after GeckoView build
        run: |
          echo "Disk space before cleanup:"
          df -h

          # Remove intermediate build files
          cd mozilla-central
          find obj-* -name "*.o" -delete
          find obj-* -name "*.a" -delete

          # Clean up apt cache and docker again
          sudo apt-get clean
          sudo docker system prune -f

          echo "Disk space after cleanup:"
          df -h

      - name: Build Fenix APK
        run: |
          cd mozilla-central/mobile/android/fenix

          VERSION="${{ steps.clone.outputs.firefox_version }}"

          # Configure Gradle for CI constraints
          cat > gradle.properties <<'EOF'
          # CI-optimized Gradle settings
          org.gradle.daemon=false
          org.gradle.parallel=false
          org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m
          org.gradle.caching=true
          org.gradle.workers.max=2
          android.builder.sdkDownload=false
          EOF

          echo "Gradle configuration:"
          cat gradle.properties

          # Configure for debug or release
          if [ "${{ env.BUILD_TYPE }}" = "release" ]; then
            echo "autosignReleaseWithDebugKey=true" > local.properties
            ./gradlew assembleRelease

            APK_DIR="app/build/outputs/apk/fenix/release"
            APK_PATTERN="*-release.apk"
            OUTPUT_NAME="firefox-custom-${VERSION}-android-release.apk"
          else
            ./gradlew assembleDebug

            APK_DIR="app/build/outputs/apk/fenix/debug"
            APK_PATTERN="*-debug.apk"
            OUTPUT_NAME="firefox-custom-${VERSION}-android-debug.apk"
          fi

          # Find and copy APK
          find "$APK_DIR" -name "$APK_PATTERN" -exec cp {} ../../../../$OUTPUT_NAME \;

          cd ../../../..
          ls -lh *.apk

          # Create checksum
          sha256sum $OUTPUT_NAME > ${OUTPUT_NAME}.sha256
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: firefox-android-${{ env.BUILD_TYPE }}-${{ github.run_number }}
          path: |
            *.apk
            *.sha256
          retention-days: 30
      
      - name: Create release
        if: env.BUILD_TYPE == 'release'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: android-v${{ steps.clone.outputs.firefox_version }}
          name: Firefox Android Custom v${{ steps.clone.outputs.firefox_version }}
          body: |
            Firefox Android Custom Build

            **Version:** ${{ steps.clone.outputs.firefox_version }}
            **Build Type:** ${{ env.BUILD_TYPE }}
            **Build Date:** ${{ github.event.repository.updated_at }}

            **Installation:**
            1. Enable "Unknown sources" in Android settings
            2. Download and install APK
            3. Settings → About → Tap logo 5 times
            4. Configure custom FxA servers

            **Note:** Debug-signed for testing
          files: |
            firefox-custom-*-android-*.apk
            firefox-custom-*-android-*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}